<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZ Server Manager</title>
    <!-- Tailwind + DaisyUI -->
    <link href="/assets/daisyui.css" rel="stylesheet" type="text/css" />
    <script src="/assets/tailwindcss.js"></script>
    <!-- Alpine.js -->
    <script defer src="/assets/alpine.js"></script>
    
    <style>
        /* 自定义滚动条样式 */
        .log-viewer::-webkit-scrollbar { width: 8px; }
        .log-viewer::-webkit-scrollbar-track { background: #1d232a; }
        .log-viewer::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        /* 防止手机端点击高亮 */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-base-300 min-h-screen pb-20 md:pb-4 flex flex-col gap-4" x-data="app()" x-init="initI18n()">

    <!-- 顶部导航 (Desktop & Mobile) -->
    <div class="navbar bg-base-100 shadow-xl z-20 sticky top-0 md:rounded-b-box md:mx-auto md:max-w-7xl md:mt-4">
        <div class="flex-1">
            <a class="btn btn-ghost text-xl text-primary gap-2">
                <!-- 图标 -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3m3 3a3 3 0 1 0 0 6h13.5a3 3 0 1 0 0-6m-16.5-3a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3m-19.5 0a4.5 4.5 0 0 1 .9-2.25l.075-.113a4.5 4.5 0 0 1 6.3 6.3l-.075.113m0 0a4.5 4.5 0 0 1-.9 2.25" />
                </svg>
                <span class="hidden md:inline" x-text="i18n.app_title || 'PZ Manager'"></span>
            </a>
        </div>
        <div class="flex-none gap-2">
            <div class="badge badge-accent badge-outline text-xs"><span x-text="i18n.status_running"></span></div>
            <select class="select select-bordered select-sm w-28" x-model="lang" @change="switchLanguage()">
                <template x-for="opt in languageList" :key="opt.code">
                    <option :value="opt.code" x-text="opt.name"></option>
                </template>
            </select>
        </div>
    </div>

    <!-- 桌面端 Tabs (md以上显示) -->
    <div class="hidden md:flex justify-center mt-2">
        <div role="tablist" class="tabs tabs-lifted tabs-lg">
            <a role="tab" class="tab" :class="currentTab === 'server' ? 'tab-active' : ''" @click="currentTab = 'server'" x-text="i18n.tab_server"></a>
            <a role="tab" class="tab" :class="currentTab === 'sandbox' ? 'tab-active' : ''" @click="currentTab = 'sandbox'" x-text="i18n.tab_sandbox"></a>
            <a role="tab" class="tab" :class="currentTab === 'monitor' ? 'tab-active' : ''" @click="currentTab = 'monitor'" x-text="i18n.tab_monitor"></a>
        </div>
    </div>

    <!-- 主内容区域 -->
    <div class="flex-1 md:container md:mx-auto md:bg-base-100 md:p-6 md:rounded-box md:shadow-lg relative">
        
        <!-- Loading -->
        <div x-show="loading" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm" style="display: none;">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>

        <!-- Tab: Server -->
        <div x-show="currentTab === 'server'" class="p-4 md:p-0 space-y-4" x-transition:enter="transition ease-out duration-200">
            <template x-for="(items, section) in serverSections" :key="section">
                <!-- 这里的 items 是当前分组下的所有配置项 -->
                <div tabindex="0" class="collapse collapse-arrow border border-base-200 bg-base-100 rounded-box shadow-sm">
                    <input type="checkbox" checked /> 
                    <div class="collapse-title text-base font-bold flex items-center gap-2">
                        <span class="w-1 h-6 bg-primary rounded-full"></span>
                        <span x-text="section"></span>
                    </div>
                    <div class="collapse-content pt-2">
                        <!-- 专门用来渲染 Mods 按钮 (只有当当前分组包含 Mods 字段时才会显示) -->
                        <template x-for="modItem in items.filter(i => i.key === 'Mods')" :key="'mod-btn-'+modItem.key">
                            <div class="bg-base-200/80 p-4 rounded-lg border border-primary/30 flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-primary/10 rounded-full text-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg>
                                    </div>
                                    <div>
                                        <!-- 标题 -->
                                        <div class="font-bold text-base" x-text="i18n.mod_section_title"></div>
                                        <!-- 描述 -->
                                        <div class="text-xs opacity-60" x-text="i18n.mod_section_desc"></div>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm md:btn-md gap-2 w-full md:w-auto" @click="openModManager()">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>
                                    <!-- 按钮文字 -->
                                    <span x-text="i18n.mod_btn_open_manager"></span>
                                </button>
                            </div>
                        </template>

                        <!-- 渲染普通字段的 Grid (过滤掉 Mods 和 WorkshopItems) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="item in items.filter(i => i.key !== 'Mods' && i.key !== 'WorkshopItems')" :key="item.key">
                                <fieldset class="fieldset bg-base-200/50 border-base-200 border rounded-lg p-3">
                                    <legend class="fieldset-legend text-xs font-bold text-primary px-2 uppercase tracking-wide" x-text="item.key || item.label"></legend>
                                    
                                    <label class="label py-0 pb-1">
                                        <span class="label-text-alt font-mono text-[10px] opacity-50 select-text" x-text="item.label"></span>
                                    </label>

                                    <template x-if="item.options">
                                        <select class="select select-bordered select-sm w-full mt-1" x-model="item.value">
                                            <template x-for="opt in item.options" :key="opt.value">
                                                <option :value="opt.value" x-text="opt.label"></option>
                                            </template>
                                        </select>
                                    </template>
                                    
                                    <template x-if="!item.options">
                                        <input type="text" class="input input-bordered input-sm w-full mt-1" x-model="item.value" />
                                    </template>
                                    
                                    <div class="mt-1 text-[10px] text-base-content/60 leading-tight truncate" x-text="item.tooltip" :title="item.tooltip"></div>
                                </fieldset>
                            </template>
                        </div>

                    </div>
                </div>
            </template>

            <!-- 浮动保存按钮 (Desktop) -->
            <div class="hidden md:flex fixed bottom-8 right-8 gap-3 z-40">
                <button class="btn btn-neutral shadow-lg gap-2" @click="saveConfig('server', false)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" /></svg>
                    <span x-text="i18n.btn_save"></span>
                </button>
                <button class="btn btn-primary shadow-lg gap-2" @click="saveConfig('server', true)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                    <span x-text="i18n.btn_save_restart"></span>
                </button>
            </div>
             <!-- 移动端保存按钮 (底部固定) -->
             <div class="md:hidden grid grid-cols-2 gap-2 mt-4">
                <button class="btn btn-neutral" @click="saveConfig('server', false)"><span x-text="i18n.btn_save"></span></button>
                <button class="btn btn-primary" @click="saveConfig('server', true)"><span x-text="i18n.btn_save_restart"></span></button>
            </div>
        </div>

        <!-- Tab 2: Sandbox  -->
        <div x-show="currentTab === 'sandbox'" class="p-4 md:p-0 space-y-4">
            <template x-for="(items, section) in sandboxSections" :key="section">
                <div tabindex="0" class="collapse collapse-arrow border border-base-200 bg-base-100 rounded-box shadow-sm">
                    <input type="checkbox" checked /> 
                    <div class="collapse-title text-base font-bold flex items-center gap-2">
                        <span class="w-1 h-6 bg-secondary rounded-full"></span>
                        <span x-text="section"></span>
                    </div>
                    <div class="collapse-content pt-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <template x-for="item in items" :key="item.key">
                                <fieldset class="fieldset bg-base-200/50 border-base-200 border rounded-lg p-3">
                                    <legend class="fieldset-legend text-xs font-bold text-secondary px-2 uppercase tracking-wide" x-text="item.key || item.label"></legend>
                                    
                                    <label class="label py-0 pb-1">
                                        <span class="label-text-alt font-mono text-[10px] opacity-50 select-text" x-text="item.label"></span>
                                    </label>

                                    <template x-if="item.options">
                                        <select class="select select-bordered select-sm w-full mt-1" x-model="item.value">
                                            <template x-for="opt in item.options" :key="opt.value">
                                                <option :value="opt.value" x-text="opt.label"></option>
                                            </template>
                                        </select>
                                    </template>
                                    <template x-if="!item.options">
                                        <input type="text" class="input input-bordered input-sm w-full mt-1" x-model="item.value" />
                                    </template>
                                    <div class="mt-1 text-[10px] text-base-content/60 leading-tight truncate" x-text="item.tooltip" :title="item.tooltip"></div>
                                </fieldset>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            <div class="md:hidden grid grid-cols-2 gap-2 mt-4">
                <button class="btn btn-neutral" @click="saveConfig('sandbox', false)">
                    <span x-text="i18n.btn_save"></span>
                </button>
                <button class="btn btn-primary" @click="saveConfig('sandbox', true)"><span x-text="i18n.btn_save_restart"></span></button>
            </div>
            <div class="hidden md:flex fixed bottom-8 right-8 gap-3 z-40">
                <button class="btn btn-neutral shadow-lg gap-2" @click="saveConfig('sandbox', false)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" /></svg>
                    <span x-text="i18n.btn_save"></span>
                </button>
                <button class="btn btn-primary shadow-lg gap-2" @click="saveConfig('sandbox', true)">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                    <span x-text="i18n.btn_save_restart"></span>
                </button>
            </div>
        </div>

        <!-- Tab 3: Monitor -->
        <div x-show="currentTab === 'monitor'" class="p-4 space-y-6" x-transition:enter="transition ease-out duration-200">
            <!-- 按钮组 -->
            <div class="grid grid-cols-2 gap-4">
                <button class="btn btn-warning h-auto py-4 flex flex-col gap-2" @click="checkUpdate()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    <span x-text="i18n.update_check"></span>
                </button>
                <button class="btn btn-error h-auto py-4 flex flex-col gap-2" @click="performAction('update_restart')">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75l3 3m0 0l3-3m-3 3v-7.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span x-text="i18n.btn_update"></span>
                </button>
            </div>

            <!-- 日志 -->
            <div class="card bg-base-100 shadow-xl border border-base-200">
                <div class="card-body p-0">
                    <div class="p-3 border-b border-base-200 flex justify-between items-center bg-base-200/50 rounded-t-box">
                        <span class="font-bold text-sm flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            Console Log
                        </span>
                        <button class="btn btn-xs btn-ghost" @click="fetchLogs">Refresh</button>
                    </div>
                    <pre class="h-[400px] overflow-auto p-4 text-xs font-mono bg-[#1e1e1e] text-green-500 log-viewer" x-text="logs"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- 移动端底部导航 Dock (DaisyUI btm-nav) -->
    <div class="btm-nav md:hidden z-50 bg-base-100 border-t border-base-200">
        <button :class="currentTab === 'server' ? 'active text-primary' : ''" @click="currentTab = 'server'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            <span class="btm-nav-label text-xs" x-text="i18n.config"></span>
        </button>
        <button :class="currentTab === 'sandbox' ? 'active text-secondary' : ''" @click="currentTab = 'sandbox'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
            <span class="btm-nav-label text-xs" x-text="i18n.sandbox"></span>
        </button>
        <button :class="currentTab === 'monitor' ? 'active text-warning' : ''" @click="currentTab = 'monitor'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            <span class="btm-nav-label text-xs" x-text="i18n.monitor"></span>
        </button>
    </div>

    <!-- Toast 通知 -->
    <div class="toast toast-end z-50">
        <div class="alert alert-success" x-show="toast.show && toast.type === 'success'" x-transition.duration.500ms>
            <span x-text="toast.message"></span>
        </div>
        <div class="alert alert-error" x-show="toast.show && toast.type === 'error'" x-transition.duration.500ms>
            <span x-text="toast.message"></span>
        </div>
    </div>
   <!-- 模组管理器 Modal -->
    <dialog id="mod_modal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl h-[80vh] flex flex-col p-0 bg-base-100">
            <!-- 标题栏 -->
            <div class="p-4 border-b border-base-200 flex justify-between items-center bg-base-200/50">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                    <span x-text="i18n.mod_manager_title"></span>
                </h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">✕</button>
                </form>
            </div>

            <!-- 内容区域 -->
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                
                <!-- 左侧：添加面板 -->
                <div class="w-full md:w-1/3 border-r border-base-200 p-4 flex flex-col gap-4 bg-base-100">
                    <div class="form-control">
                        <label class="label"><span class="label-text font-bold" x-text="i18n.mod_add_workshop_label"></span></label>
                        <textarea 
                            class="textarea textarea-bordered h-32 font-mono text-sm" 
                            :placeholder="i18n.mod_add_placeholder"
                            x-model="modInput"
                        ></textarea>
                    </div>
                    <button class="btn btn-primary w-full" @click="lookupAndAddMods()" :disabled="modLoading">
                        <span x-show="modLoading" class="loading loading-spinner"></span>
                        <span x-show="!modLoading" x-text="i18n.mod_btn_analyze"></span>
                    </button>
                    
                    <div class="divider" x-text="i18n.mod_divider_or"></div>
                    
                    <!-- 本地已下载列表 -->
                    <div class="flex-1 overflow-y-auto border border-base-200 rounded-box p-2">
                        <div class="text-xs font-bold mb-2 text-base-content/50 px-2" x-text="i18n.mod_local_list_title"></div>
                        <template x-for="mod in availableMods" :key="mod.mod_id">
                            <div class="flex justify-between items-center p-2 hover:bg-base-200 rounded cursor-pointer group" @click="addFromLocal(mod)">
                                <div class="truncate flex-1">
                                    <div class="font-bold text-xs truncate" x-text="mod.name"></div>
                                    <div class="text-[10px] text-base-content/60" x-text="mod.mod_id"></div>
                                </div>
                                <button class="btn btn-xs btn-ghost text-primary opacity-0 group-hover:opacity-100">+</button>
                            </div>
                        </template>
                        <div x-show="availableMods.length === 0" class="text-center text-xs p-4 text-base-content/50" x-text="i18n.mod_local_list_empty"></div>
                    </div>
                </div>

                <!-- 右侧：已启用列表 -->
                <div class="flex-1 p-4 flex flex-col bg-base-200/30">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-sm">
                            <span x-text="i18n.mod_active_list_title"></span> 
                            (<span x-text="activeMods.length"></span>)
                        </span>
                        <button class="btn btn-xs btn-ghost text-error" @click="activeMods = []" x-show="activeMods.length > 0" x-text="i18n.mod_btn_clear_all"></button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto space-y-2 pr-2">
                        <template x-for="(mod, index) in activeMods" :key="index">
                            <div class="card card-compact bg-base-100 shadow-sm border border-base-200 group">
                                <div class="card-body flex-row items-center gap-3 p-3">
                                    <div class="badge badge-neutral text-xs font-mono h-6 w-6 shrink-0" x-text="index + 1"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-bold text-sm truncate text-primary" x-text="mod.name || i18n.mod_unknown_name"></div>
                                        <div class="flex gap-2 text-[10px] text-base-content/60 font-mono">
                                            <span class="bg-base-200 px-1 rounded">W: <span x-text="mod.workshop_id"></span></span>
                                            <span class="bg-base-200 px-1 rounded">M: <span x-text="mod.mod_id"></span></span>
                                        </div>
                                    </div>
                                    <!-- 按钮保持原样，只有图标和逻辑 -->
                                    <div class="flex gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button class="btn btn-xs btn-square btn-ghost" @click="moveMod(index, -1)" :disabled="index === 0">▲</button>
                                        <button class="btn btn-xs btn-square btn-ghost" @click="moveMod(index, 1)" :disabled="index === activeMods.length - 1">▼</button>
                                        <button class="btn btn-xs btn-square btn-ghost text-error" @click="removeMod(index)">✕</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="activeMods.length === 0" class="flex flex-col items-center justify-center h-full text-base-content/30 gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                            <p class="text-sm" x-text="i18n.mod_active_empty"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 底部栏 -->
            <div class="p-4 border-t border-base-200 flex justify-end gap-2 bg-base-100">
                <form method="dialog">
                    <button class="btn" x-text="i18n.btn_cancel"></button>
                </form>
                <button class="btn btn-primary px-8" @click="saveModsToConfig()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    <span x-text="i18n.mod_btn_apply"></span>
                </button>
            </div>
        </div>
    </dialog>

    <script>
        function app() {
            return {
                currentTab: 'server',
                lang: localStorage.getItem('pz_lang') || 'CN', // 记住用户选择
                i18n: {}, // 存放当前语言的 UI 文本
                languageList: [], // 存放从后端获取的语言列表
                loading: false,
                serverConfig: [],
                sandboxConfig: [],
                serverSections: {},
                sandboxSections: {},
                logs: '...',
                status: { pid: 0, uptime: '0s' },
                toast: { show: false, message: '', type: 'success' },
                modInput: '',
                modLoading: false,
                availableMods: [], // 本地库
                activeMods: [],    // 当前启用列表


                init() {
                    this.refreshAll();
                },

                refreshAll() {
                    this.fetchConfig('server');
                    this.fetchConfig('sandbox');
                    // 预留: this.fetchStatus();
                },

                async initI18n() {
                    this.loading = true;
                    try {
                        // 请求语言列表和 UI 文本
                        const res = await fetch(`/api/i18n?lang=${this.lang}`);
                        const data = await res.json();
                        
                        this.languageList = data.languages;
                        this.i18n = data.ui;
                        this.logs = this.i18n.log_refresh_hint || 'Click refresh...';
                        
                        // 加载完 I18n 后再加载配置
                        this.refreshAll();
                    } catch (e) {
                        console.error("Failed to init i18n", e);
                    } finally {
                        this.loading = false;
                    }
                },

                async switchLanguage() {
                    localStorage.setItem('pz_lang', this.lang);
                    // 重新加载 UI 文本和配置项翻译
                    await this.initI18n();
                },

                // 统一获取配置并分组
                async fetchConfig(type) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/api/config/${type}?lang=${this.lang}`);
                        const data = await res.json();
                        
                        // 按 Section 分组
                        const grouped = data.items.reduce((acc, item) => {
                            const section = item.section || 'General';
                            if (!acc[section]) acc[section] = [];
                            acc[section].push(item);
                            return acc;
                        }, {});

                        if (type === 'server') {
                            this.serverConfig = data.items; // 保存原始数组用于提交
                            this.serverSections = grouped;
                        } else {
                            this.sandboxConfig = data.items;
                            this.sandboxSections = grouped;
                        }
                    } catch (e) {
                        this.showToast((this.i18n.msg_config_load_fail || 'Load failed') + ': ' + e, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // 打开管理器
                async openModManager() {
                    this.modLoading = true;
                    const availableModsResp = await fetch(`/api/mods`);
                    this.availableMods = await availableModsResp.json()
                    // 从 serverConfig 解析当前配置
                    const modsItem = this.serverConfig.find(i => i.key === 'Mods');
                    const wsItem = this.serverConfig.find(i => i.key === 'WorkshopItems');
                    
                    const currentModIds = (modsItem ? modsItem.value : "")
                    .split(';')
                    .map(s => s.trim().replace(/^\\/, '')) // 去除开头的 \
                    .filter(Boolean);
                    const currentWsIds = (wsItem ? wsItem.value : "").split(';').filter(Boolean);
                    // 如果没有任何工坊物品，直接清空列表并打开
                    if (currentWsIds.length === 0) {
                        this.modLoading = false;
                        this.activeMods = [];
                        document.getElementById('mod_modal').showModal();
                        return;
                    }
                    document.getElementById('mod_modal').showModal();
                    const res = await fetch(`/api/mods/lookup?ids=${currentWsIds.join(',')}`);
                    const lookupData = await res.json();
                    this.modLoading = false;
                    this.activeMods = [];
                    currentWsIds.forEach(wid => {
                        const info = lookupData.find(d => d.workshop_id === wid);
                        if (info) {
                            // 一个 Workshop Item 可能包含多个 Mod ID
                            // 需要判断 currentModIds 里包含 info.mod_id 里的哪些
                            // 获取该工坊物品包含的所有潜在 ModID (后端返回的是逗号分隔字符串 "id1,id2")
                            const potentialModIds = info.mod_id.split(',').map(s => s.trim());
                            
                            // 在当前启用的 Mods 里找，有哪些是属于这个 Workshop 的
                            const enabledSubMods = potentialModIds.filter(pmid => currentModIds.includes(pmid));
                            
                            if (enabledSubMods.length > 0) {
                                // 如果找到了匹配的，添加进列表
                                enabledSubMods.forEach(mid => {
                                    this.activeMods.push({
                                        name: info.name + (enabledSubMods.length > 1 ? ` (${mid})` : ''),
                                        workshop_id: wid,
                                        mod_id: mid
                                    });
                                });
                            }
                        } else {
                            // 没查到信息 (网络错误或ID不存在)，显示 ID
                            this.activeMods.push({
                                name: `Unknown Item (${wid})`,
                                workshop_id: wid,
                                mod_id: '?'
                            });
                        }
                    });
                    document.getElementById('mod_modal').showModal();
                },

                // 解析输入框并添加
                async lookupAndAddMods() {
                    if (!this.modInput.trim()) return;
                    
                    // 处理逗号分隔
                    const rawIds = this.modInput.split(/[,，;\n]/).map(s => s.trim()).filter(Boolean);
                    if (rawIds.length === 0) return;

                    this.modLoading = true;
                    try {
                        const res = await fetch(`/api/mods/lookup?ids=${rawIds.join(',')}`);
                        const data = await res.json();
                        
                        for (const item of data) {
                            this.addModItem(item);
                        }
                        
                        this.modInput = ''; // 清空输入框
                    } catch (e) {
                         this.showToast((this.i18n.msg_parse_fail || 'Parse failed') + ': ' + e, 'error');
                    } finally {
                        this.modLoading = false;
                    }
                },

                // 添加单个 Mod 项目 (处理多 ModID 情况)
                addModItem(item) {
                    // 检查 ModID 是否存在
                    let mid = item.mod_id;
                    
                    // 2. 如果包含多个 ID (例如 "ID1,ID2")
                    if (mid.includes(',')) {
                        const choices = mid.split(',');
                        // 简单起见，全部添加，让用户自己删？或者弹窗选？
                        // 这里我们全部添加进去，这最省事
                        choices.forEach(subId => {
                            this.pushToActive({
                                name: item.name + ` (${subId})`, // 区分名字
                                workshop_id: item.workshop_id,
                                mod_id: subId.trim()
                            });
                        });
                        return;
                    }

                    //  如果 ModID 未知 (?)
                    if (mid === '?' || mid === 'Unknown (Check Page)') {
                         const msg = (this.i18n.prompt_mod_id_manual || '').replace('{0}', item.name);
                        mid = prompt(msg || `Please enter Mod ID for ${item.name}:`);
                        if (!mid) return;
                    }
                    
                    this.pushToActive({
                        name: item.name,
                        workshop_id: item.workshop_id,
                        mod_id: mid
                    });
                },
                //添加到列表并去重
                pushToActive(modObj) {
                    // 检查是否已存在 (根据 ModID)
                    if (this.activeMods.some(m => m.mod_id === modObj.mod_id)) return;
                    this.activeMods.push(modObj);
                },
                // 从本地库添加
                addFromLocal(mod) {
                    this.pushToActive(mod);
                },

                // 移除
                removeMod(index) {
                    this.activeMods.splice(index, 1);
                },

                // 排序
                moveMod(index, delta) {
                    const newIndex = index + delta;
                    if (newIndex < 0 || newIndex >= this.activeMods.length) return;
                    
                    const temp = this.activeMods[index];
                    this.activeMods[index] = this.activeMods[newIndex];
                    this.activeMods[newIndex] = temp;
                },

                // 保存回 Server Config
                saveModsToConfig() {
                    // 提取 Mod IDs (分号分隔)
                    const modsStr = this.activeMods
                    .map(m => `\\${m.mod_id}`) // 加反斜杠，配置是那么写的。
                    .join(';');
                    
                    // 提取 Workshop IDs (分号分隔，去重)
                    // 注意：过滤掉 '?' 和本地已有的 workshopID
                    const wsIds = [...new Set(this.activeMods.map(m => m.workshop_id).filter(id => id && id !== '?'))];
                    const wsStr = wsIds.join(';');

                    // 更新 serverConfig 数组
                    const modsItem = this.serverConfig.find(i => i.key === 'Mods');
                    const wsItem = this.serverConfig.find(i => i.key === 'WorkshopItems');

                    if (modsItem) modsItem.value = modsStr;
                    if (wsItem) wsItem.value = wsStr;

                    document.getElementById('mod_modal').close();
                    this.showToast(this.i18n.msg_mod_list_updated, 'success');
                },

                // 保存配置
                async saveConfig(type, restart) {
                    if (restart && !confirm(this.i18n.confirm_save_restart)) return;
                    this.loading = true;
                    try {
                        const items = type === 'server' ? this.serverConfig : this.sandboxConfig;

                        const res = await fetch(`/api/config/${type}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ items: items, restart: restart })
                        });

                        if (!res.ok) throw new Error(this.i18n.msg_save_fail);

                        this.showToast(this.i18n.msg_save_success, 'success');

                    } catch (e) {
                        this.showToast(e.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async performAction(action) {
                    this.loading = true;
                    try {
                        const res = await fetch(`/api/action/${action}`, { method: 'POST' });
                        if (res.ok) {
                             this.showToast((this.i18n.msg_cmd_sent || 'Command Sent') + ': ' + action, 'success');
                        } else {
                            throw new Error(this.i18n.msg_exec_fail);
                        }
                    } catch (e) {
                        this.showToast(e.message, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async fetchLogs() {
                    try {
                         const res = await fetch('/api/logs');
                         const data = await res.json();
                         this.logs = data.logs;
                    } catch {
                        this.logs = this.i18n.log_fetch_error;
                    }
                },

                showToast(msg, type = 'success') {
                    this.toast.message = msg;
                    this.toast.type = type;
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 3000);
                },

                async checkUpdate() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/system/check_update');
                        const data = await res.json();
                        if (data.new_version) {
                            // 获取模板文本
                            let msg = this.i18n.msg_update_found || 'New version {0} found (Current: {1})\nUpdate now?';
                            
                            // 简单的手动替换占位符
                            msg = msg.replace('{0}', data.new_version)
                                    .replace('{1}', data.current);

                            if (confirm(msg)) {
                                await fetch('/api/system/perform_update', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({ url: data.download_url })
                                });
                                // 使用 i18n
                                alert(this.i18n.msg_update_performing || 'Update command sent, please refresh later.');
                            }
                        } else {
                            if(data.error) {
                                this.showToast(data.error, 'error');
                                return
                            }
                            // 使用 i18n
                            this.showToast(this.i18n.msg_already_latest || 'Already latest version');
                        }
                    } catch(e) {
                        // 使用 i18n
                        this.showToast(this.i18n.msg_update_check_fail || 'Check update failed', 'error');
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>